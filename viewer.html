<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SyncFlix Viewer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>
<h2>ðŸ‘€ Viewer</h2>
<video id="screen" autoplay playsinline></video>

<div>
  <input id="msg" placeholder="message">
  <button onclick="sendChat()">Send</button>
  <div id="chat"></div>
</div>

<script>
const room = "demo";

const SIGNALING_SERVER =
  location.hostname
    ? `${location.protocol === "https:" ? "wss" : "ws"}://${location.host}`
    : "wss://syncflix.onrender.com";

const ws = new WebSocket(
  `${SIGNALING_SERVER}?room=${room}&role=viewer`
);

let pc = null;

ws.onmessage = async e => {
  const d = JSON.parse(e.data);

  if (d.type === "chat") addChat(d.sender, d.message);

  if (d.type === "offer") {
    pc = new RTCPeerConnection();

    pc.ontrack = e => {
      screen.srcObject = e.streams[0];
    };

    pc.onicecandidate = e => {
      if (e.candidate) {
        ws.send(JSON.stringify({ type: "ice", payload: e.candidate }));
      }
    };

    await pc.setRemoteDescription(d.payload);
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);

    ws.send(JSON.stringify({ type: "answer", payload: answer }));
  }

  if (d.type === "ice" && pc) {
    pc.addIceCandidate(d.payload);
  }
};

function sendChat() {
  if (!msg.value) return;
  ws.send(JSON.stringify({ type: "chat", message: msg.value }));
  addChat("You", msg.value);
  msg.value = "";
}

function addChat(sender, text) {
  chat.innerHTML += `<div><b>${sender}:</b> ${text}</div>`;
}
</script>
</body>
</html>
