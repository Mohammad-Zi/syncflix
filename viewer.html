<script>
let peerConnection = null;
let pendingIceCandidates = [];

async function handleOffer(senderId, sdp) {
  peerConnection = new RTCPeerConnection();

  peerConnection.onicecandidate = e => {
    if (e.candidate) {
      ws.send(JSON.stringify({
        type: 'ice-candidate',
        target: senderId,
        candidate: e.candidate
      }));
    }
  };

  peerConnection.ontrack = e => {
    document.getElementById('remoteScreen').srcObject = e.streams[0];
  };

  await peerConnection.setRemoteDescription(new RTCSessionDescription(sdp));

  const answer = await peerConnection.createAnswer();
  await peerConnection.setLocalDescription(answer);

  ws.send(JSON.stringify({
    type: 'answer',
    target: senderId,
    sdp: peerConnection.localDescription
  }));

  for (const c of pendingIceCandidates) {
    await peerConnection.addIceCandidate(new RTCIceCandidate(c));
  }
  pendingIceCandidates = [];
}

async function handleIceCandidate(_, candidate) {
  if (!peerConnection || !peerConnection.remoteDescription) {
    pendingIceCandidates.push(candidate);
    return;
  }
  await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
}
</script>
