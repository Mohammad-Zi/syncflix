<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Viewer</title>
</head>
<body>
  <h2>Viewer â€“ Watch Screen</h2>
  <video id="remote" autoplay playsinline></video>

<script>
const SERVER =
  location.protocol === "https:"
    ? `wss://${location.host}/ws?role=viewer`
    : `ws://${location.host}/ws?role=viewer`;

let ws;
let pc;
let pendingCandidates = [];

ws = new WebSocket(SERVER);

ws.onmessage = async e => {
  const msg = JSON.parse(e.data);

  if (msg.type === "offer") {
    pc = new RTCPeerConnection({
      iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
    });

    pc.ontrack = e => {
      document.getElementById("remote").srcObject = e.streams[0];
    };

    pc.onicecandidate = e => {
      if (e.candidate) {
        ws.send(JSON.stringify({ type: "ice-candidate", candidate: e.candidate }));
      }
    };

    await pc.setRemoteDescription({ type: "offer", sdp: msg.sdp });

    for (const c of pendingCandidates) await pc.addIceCandidate(c);
    pendingCandidates = [];

    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);

    ws.send(JSON.stringify({ type: "answer", sdp: answer.sdp }));
  }

  if (msg.type === "ice-candidate") {
    if (pc && pc.remoteDescription) {
      await pc.addIceCandidate(msg.candidate);
    } else {
      pendingCandidates.push(msg.candidate);
    }
  }
};
</script>
</body>
</html>
