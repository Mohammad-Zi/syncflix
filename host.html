<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Host</title>
</head>
<body>
  <h2>Host â€“ Share Screen</h2>
  <button onclick="start()">Start Screen Share</button>
  <video id="local" autoplay muted></video>

<script>
const SERVER =
  location.protocol === "https:"
    ? `wss://${location.host}/ws?role=host`
    : `ws://${location.host}/ws?role=host`;

let ws;
let pc;
let stream;
let pendingCandidates = [];

async function start() {
  ws = new WebSocket(SERVER);

  ws.onmessage = async e => {
    const msg = JSON.parse(e.data);

    if (msg.type === "answer") {
      await pc.setRemoteDescription({ type: "answer", sdp: msg.sdp });
      for (const c of pendingCandidates) await pc.addIceCandidate(c);
      pendingCandidates = [];
    }

    if (msg.type === "ice-candidate") {
      if (pc.remoteDescription) {
        await pc.addIceCandidate(msg.candidate);
      } else {
        pendingCandidates.push(msg.candidate);
      }
    }
  };

  stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
  document.getElementById("local").srcObject = stream;

  pc = new RTCPeerConnection({
    iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
  });

  stream.getTracks().forEach(t => pc.addTrack(t, stream));

  pc.onicecandidate = e => {
    if (e.candidate) {
      ws.send(JSON.stringify({ type: "ice-candidate", candidate: e.candidate }));
    }
  };

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);

  ws.send(JSON.stringify({ type: "offer", sdp: offer.sdp }));
}
</script>
</body>
</html>
