<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SyncFlix Host</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>
<h2>ðŸŽ¥ Host</h2>
<button onclick="startScreen()">Start Screen</button>
<video id="screen" autoplay muted></video>

<div>
  <input id="msg" placeholder="message">
  <button onclick="sendChat()">Send</button>
  <div id="chat"></div>
</div>

<script>
const room = "demo";

const SIGNALING_SERVER =
  location.hostname
    ? `${location.protocol === "https:" ? "wss" : "ws"}://${location.host}`
    : "wss://syncflix.onrender.com";

const ws = new WebSocket(
  `${SIGNALING_SERVER}?room=${room}&role=host`
);

let pc = null;
let stream = null;

ws.onmessage = e => {
  const d = JSON.parse(e.data);
  if (d.type === "chat") addChat(d.sender, d.message);
  if (d.type === "answer" && pc) pc.setRemoteDescription(d.payload);
  if (d.type === "ice" && pc) pc.addIceCandidate(d.payload);
};

async function startScreen() {
  stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
  screen.srcObject = stream;

  pc = new RTCPeerConnection();
  stream.getTracks().forEach(t => pc.addTrack(t, stream));

  pc.onicecandidate = e => {
    if (e.candidate) {
      ws.send(JSON.stringify({ type: "ice", payload: e.candidate }));
    }
  };

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);

  ws.send(JSON.stringify({ type: "offer", payload: offer }));
  ws.send(JSON.stringify({ type: "screen-started" }));
}

function sendChat() {
  if (!msg.value) return;
  ws.send(JSON.stringify({ type: "chat", message: msg.value }));
  addChat("You", msg.value);
  msg.value = "";
}

function addChat(sender, text) {
  chat.innerHTML += `<div><b>${sender}:</b> ${text}</div>`;
}
</script>
</body>
</html>
